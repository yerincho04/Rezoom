<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Profile</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-300 min-h-screen font-sans">

<!-- Header -->
<%- include('partials/header', { email }) %>

  <!-- Main content -->
  <main class="max-w-5xl mx-auto p-8 space-y-8">

<!-- Profile Card + Sign Out -->
<div class="bg-white p-6 rounded-lg shadow flex justify-between items-center">
  
  <!-- Profile Info -->
  <div class="flex items-center space-x-6">
    <div class="w-24 h-24 rounded-full bg-yellow-600 flex items-center justify-center text-white text-2xl font-bold">
      <%= user.profile?.nickname?.charAt(0).toUpperCase() || "U" %>
    </div>
    <div>
      <h1 class="text-xl font-bold"><%= user.profile?.nickname || "Your Name" %></h1>
      <p class="text-sm text-gray-500"><%= email %></p>
    </div>
  </div>

  <!-- Sign Out Button -->
  <form action="/logout" method="POST">
    <button type="submit" class="bg-gray-300 text-black px-6 py-2 rounded hover:bg-gray-400">
      Sign Out
    </button>
  </form>

</div>

<!-- Profile Form -->
<div class="bg-white p-6 rounded-lg shadow">
  <h2 class="text-lg font-bold mb-4">Profile</h2>
  <form action="/profile" method="POST" class="space-y-4">
    <div>
      <label class="block text-sm font-medium text-gray-700">이름</label>
      <input type="text" name="name" value="<%= user.profile.name %>" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">나이</label>
      <input type="number" name="age" value="<%= user.profile.age %>" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">대학교</label>
      <input type="text" name="university" value="<%= user.profile.university %>" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">GPA</label>
      <input type="text" name="gpa" value="<%= user.profile.gpa %>" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700">닉네임</label>
      <input type="text" name="nickname" value="<%= user.profile.nickname %>" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
    </div>
    <button type="submit" class="w-full bg-gray-300 text-black py-2 px-4 rounded hover:bg-gray-400">Save</button>
  </form>
</div>

<!-- Score Progression Graph -->
<div class="bg-white p-6 rounded-lg shadow">
  <h2 class="text-lg font-bold mb-4">자기소개서 점수</h2>
  <div class="h-64">
    <canvas id="scoreChart"></canvas>
  </div>
</div>

<script>
  // Prepare data for the chart
  const feedbackData = <%- JSON.stringify(feedbackHistory) %>;
  const dates = feedbackData.map(fb => {
    const date = new Date(fb.created_at);
    return `${date.getMonth() + 1}/${date.getDate()}`;
  });
  const scores = feedbackData.map(fb => fb.score || null);

  // Create the chart
  const ctx = document.getElementById('scoreChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: '자기소개서 점수',
        data: scores,
        borderColor: 'rgb(59, 130, 246)',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        tension: 0.4,
        fill: true,
        pointRadius: 4,
        pointBackgroundColor: 'rgb(59, 130, 246)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 10,
          title: {
            display: true,
            text: '점수'
          }
        },
        x: {
          title: {
            display: true,
            text: '날짜'
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `점수: ${context.raw}/10`;
            }
          }
        }
      }
    }
  });
</script>

  </main>
</body>
</html>
