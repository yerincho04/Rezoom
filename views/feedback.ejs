<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>자소서 피드백</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-300 font-sans">

  <!-- Header -->
  <%- include('partials/header', { email }) %>

  <main class="max-w-5xl mx-auto mt-12 bg-white p-6 rounded shadow space-y-6">
  <h1 class="text-2xl font-bold">자기소개서 피드백</h1>

  <!-- 기업명 + 모집 직무 -->
<div class="flex gap-4 mb-4">
  <input id="companyInput" placeholder="기업명 입력" class="flex-1 px-3 py-2 border rounded" />
  <input id="positionInput" placeholder="모집 직무 입력" class="flex-1 px-3 py-2 border rounded" />
</div>

<!-- 파일 업로드 -->
<div class="flex gap-2 items-center mb-4">
  <input type="file" id="resumeInput" class="border px-2 py-1 rounded" />
  <button onclick="sendFile()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
    보내기
  </button>
</div>

<!-- 첨부된 파일 표시 -->
<p id="fileInfo" class="text-sm text-gray-500 mb-6 hidden"></p>

<!-- GPT Chat Area -->
<div id="chatBox" class="h-96 overflow-y-auto border p-4 bg-gray-50 rounded mb-4 space-y-3 text-sm"></div>
<div id="loadingMessage" class="text-gray-500 text-sm mb-4 hidden">
  🤖 답변을 작성 중입니다...
</div>

  <!-- 메시지 전송 -->
  <div class="flex space-x-2">
    <input type="text" id="userInput" class="flex-1 px-4 py-2 border rounded text-sm" placeholder="피드백 질문을 입력하세요" />
    <button onclick="sendMessage()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">전송</button>
  </div>
</main>

<script>
  const chatBox = document.getElementById('chatBox');
  const fileInput = document.getElementById('resumeInput');
  const fileInfo = document.getElementById('fileInfo');
  const loadingMessage = document.getElementById('loadingMessage');
  const companyInput = document.getElementById('companyInput');
  const positionInput = document.getElementById('positionInput');
  let conversationHistory = [];

  function addMessage(sender, text) {
    const wrapper = document.createElement('div');
    wrapper.className = 'w-full flex';

    const msgDiv = document.createElement('div');
    msgDiv.className = `px-3 py-2 rounded-lg max-w-[80%] text-sm ${
      sender === 'user'
        ? 'bg-blue-500 text-white ml-auto'
        : 'bg-gray-200 text-gray-800 mr-auto'
    }`;

    msgDiv.innerHTML = `${sender === 'user' ? '🧑' : '🤖'}: ${text.replace(/\n/g, '<br>')}`;
    wrapper.appendChild(msgDiv);
    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;

    const role = sender === 'user' ? 'user' : 'assistant';
    conversationHistory.push({ role: role, content: text });
  }

  async function sendFile() {
    const file = fileInput.files[0];
    const company = companyInput.value.trim();
    const position = positionInput.value.trim();

    if (!file || !company || !position) {
      alert("기업명, 모집 직무, 그리고 파일을 모두 입력해주세요.");
      return;
    }

    fileInfo.textContent = `📎 첨부된 파일: ${file.name}`;
    fileInfo.classList.remove('hidden');
    addMessage('bot', `✅ "${file.name}" 파일이 업로드되었어요.`);
    loadingMessage.classList.remove('hidden');

    const formData = new FormData();
    formData.append("company", company);
    formData.append("position", position);
    formData.append("file", file);

    try {
      const res = await fetch('/feedback/submit', {
        method: 'POST',
        body: formData,
      });
      const data = await res.json();
      if (data.feedback) addMessage('bot', data.feedback);
      if (data.todo) addMessage('bot', data.todo);
      if (data.error) addMessage('bot', `⚠️ ${data.error}`);
    } catch {
      addMessage('bot', '⚠️ 서버 오류가 발생했습니다.');
    } finally {
      loadingMessage.classList.add('hidden');
    }
  }

  let isSending = false;
  async function sendMessage() {
  if (isSending) return;
    isSending = true;

    const input = document.getElementById('userInput');
    const text = input.value.trim();
    if (!text) {
      isSending = false;
      return;
    }

    setTimeout(() => {
      input.value = '';
    }, 0);

    addMessage('user', text);
    loadingMessage.classList.remove('hidden');

    try {
      const res = await fetch('/chat/message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          message: text,
          conversationHistory: conversationHistory 
        }),
      });
      const data = await res.json();
      addMessage('bot', data.reply);
    } catch {
      addMessage('bot', '⚠️ GPT 응답에 실패했습니다.');
    } finally {
      loadingMessage.classList.add('hidden');
      isSending = false;
    }
  }


  document.getElementById('userInput').addEventListener('keydown', function (e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
</script>

</body>
</html>
